<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AraÃ§ Fiyat Paneli</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
  <main class="container">
    <h1>AraÃ§ Fiyat Paneli</h1>
    <p class="subtitle">Marka ve modeli listeden seÃ§in, ilan kaynaklarÄ±ndan ortalama fiyat ve %10 kÃ¢rla satÄ±ÅŸ fiyatÄ±nÄ±
      gÃ¶rÃ¼n.</p>

    <form action="/analyze" method="POST" class="panel">
      <div class="grid">
        <label>
          AraÃ§ Kategorisi
          <select id="categorySelect" name="category" required>
            <option value="otomobil" <%- (form.category==='otomobil' || !form.category) ? 'selected' : '' %>>Otomobil
            </option>
            <option value="arazi-suv-pick-up" <%- form.category==='arazi-suv-pick-up' ? 'selected' : '' %>>Arazi, SUV,
              Pick-up</option>
            <option value="minivan-panelvan" <%- form.category==='minivan-panelvan' ? 'selected' : '' %>>Minivan &
              Panelvan</option>
          </select>
        </label>

        <label>
          Marka
          <select id="brandSelect" name="brand" required data-selected-brand="<%= form.brand || '' %>">
            <option value="">Kategori seÃ§in...</option>
          </select>
        </label>

        <label>
          Model
          <select id="modelGroupSelect" required disabled>
            <option value="">Ã–nce marka seÃ§in</option>
          </select>
        </label>

        <label>
          Versiyon
          <select id="versionSelect" name="model" required disabled data-selected-version="<%= form.model || '' %>">
            <option value="">Ã–nce model seÃ§in</option>
          </select>
        </label>

        <label>
          YÄ±l (AralÄ±k veya Tek YÄ±l)
          <input type="text" name="yil" value="<%= form.yil || '' %>" placeholder="Ã–rn: 2011-2012 veya 2011" />
        </label>

        <label>
          Vites Tipi
          <select name="vites">
            <option value="manuel" <%- (!form.vites || form.vites==='manuel' ) ? 'selected' : '' %>>Manuel</option>
            <option value="otomatik" <%- form.vites==='otomatik' ? 'selected' : '' %>>Otomatik</option>
            <option value="yari-otomatik" <%- form.vites==='yari-otomatik' ? 'selected' : '' %>>YarÄ± Otomatik</option>
          </select>
        </label>

        <label>
          KM
          <input type="number" min="0" step="1000" name="km" value="<%= form.km %>" placeholder="Ã–rn: 145000" />
        </label>

        <label>
          DeÄŸiÅŸen ParÃ§a SayÄ±sÄ±
          <input type="number" min="0" name="degisenSayisi" value="<%= form.degisenSayisi %>" />
        </label>

        <label>
          Hasar KaydÄ± (TL)
          <input type="number" min="0" step="1000" name="hasarKaydiTl" value="<%= form.hasarKaydiTl %>" />
        </label>

        <label>
          BoyalÄ± ParÃ§a SayÄ±sÄ±
          <input type="number" min="0" name="boyaSayisi" value="<%= form.boyaSayisi %>" />
        </label>
      </div>

      <%# Gizli alanlar - JS tarafÄ±ndan doldurulur %>
        <input type="hidden" id="modelSlugInput" name="modelSlug" value="<%= form.modelSlug   || '' %>" />
        <input type="hidden" id="versionSlugInput" name="versionSlug" value="<%= form.versionSlug || '' %>" />

        <button type="submit">Fiyat Analizi Yap</button>
    </form>

    <% if (error) { %>
      <section class="alert">
        <%= error %>
      </section>
      <% } %>

        <% if (result) { %>
          <section class="panel results">
            <h2>SonuÃ§lar</h2>
            <div class="result-meta">
              <% if (form.yil) { %><span>ğŸ“… <%= form.yil %> Model</span>
                <% } %>
                  <span>âš™ï¸ <%= form.vites==='otomatik' ? 'Otomatik' : (form.vites==='yari-otomatik' ? 'YarÄ± Otomatik'
                      : 'Manuel' ) %> Vites</span>
            </div>
            <div class="cards">
              <article>
                <h3>Piyasa Ortalama Fiyat</h3>
                <strong>
                  <%= result.formatted.marketAverage %>
                </strong>
              </article>
              <article>
                <h3>Duruma GÃ¶re DÃ¼zeltilmiÅŸ</h3>
                <strong>
                  <%= result.formatted.adjustedPrice %>
                </strong>
                <% if (result.adjustmentPercent !==null) { %>
                  <span>
                    <%= result.adjustmentPercent %>% dÃ¼zeltme
                  </span>
                  <% } %>
              </article>
              <article>
                <h3>%10 KÃ¢rla SatÄ±ÅŸ FiyatÄ±</h3>
                <strong>
                  <%= result.formatted.salePriceWithProfit %>
                </strong>
              </article>
            </div>

            <h3>Kaynaklar</h3>
            <div class="result-providers">
              <% result.providers.forEach(provider=> { %>
                <div class="provider-card" data-source="<%= provider.source %>">
                  <span class="provider-name">
                    <%= provider.source %>
                  </span>
                  <div class="provider-info">
                    <span class="price-count <%= provider.prices.length === 0 ? 'no-results' : '' %>">
                      <%= provider.prices.length %> fiyat bulundu
                    </span>

                    <% if (provider.note==='versiyon_genisletildi' ) { %>
                      <em>âš ï¸ SeÃ§ilen versiyon iÃ§in ilan az, model geneline geniÅŸletildi</em>
                      <% } %>

                        <% if (provider.expanded) { %>
                          <em>âš ï¸ Bu yÄ±l iÃ§in ilan az, Â±1 yÄ±l aralÄ±ÄŸÄ±ndaki ilanlar gÃ¶steriliyor</em>
                          <% } %>
                            <% if (provider.fallback) { %>
                              <em>âš ï¸ Filtreyle ilan bulunamadÄ±, tÃ¼m ilanlar gÃ¶steriliyor</em>
                              <% } %>

                                <a href="<%= provider.url %>" target="_blank" class="external-link">FiltrelenmiÅŸ
                                  Ä°lanlarÄ± AÃ§
                                  â†’</a>
                  </div>
                </div>
                <% }) %>
            </div>
          </section>
          <% } %>


            <p class="note">Not: Ä°lan sitelerinin yapÄ± veya eriÅŸim politikalarÄ± deÄŸiÅŸtiÄŸinde fiyat Ã§ekme sonuÃ§larÄ±
              etkilenebilir.</p>
  </main>

  <script>
    (function () {
      const categorySelect = document.getElementById('categorySelect');
      const brandSelect = document.getElementById('brandSelect');
      const modelGroupSelect = document.getElementById('modelGroupSelect');
      const versionSelect = document.getElementById('versionSelect');
      const modelSlugInput = document.getElementById('modelSlugInput');
      const versionSlugInput = document.getElementById('versionSlugInput');
      if (!brandSelect || !modelGroupSelect || !versionSelect || !categorySelect) return;

      const selectedBrand = (brandSelect.dataset.selectedBrand || '').toLowerCase();
      const selectedFull = (versionSelect.dataset.selectedVersion || '');

      let currentBrand = '';

      function renderOptions(selectEl, options, placeholder) {
        selectEl.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = placeholder;
        selectEl.appendChild(defaultOption);
        options.forEach((item) => {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.count ? `${item.label} (${item.count})` : item.label;
          selectEl.appendChild(option);
        });
      }

      async function loadBrands(category) {
        brandSelect.disabled = true;
        renderOptions(brandSelect, [], 'Markalar yÃ¼kleniyor...');
        try {
          const response = await fetch(`/api/brands?category=${encodeURIComponent(category)}`);
          const payload = await response.json();
          const brands = (payload.brands || []).map((brand) => ({
            value: brand.slug,
            label: brand.name,
            count: brand.count
          }));
          renderOptions(brandSelect, brands, 'Marka seÃ§in');
          brandSelect.disabled = false;
          if (selectedBrand && category === (categorySelect.value || 'otomobil')) {
            brandSelect.value = selectedBrand;
            await loadModels(category, selectedBrand);
          }
        } catch (error) {
          renderOptions(brandSelect, [], 'Markalar alÄ±namadÄ±');
          brandSelect.disabled = true;
        }
      }

      async function loadModels(category, brandSlug) {
        currentBrand = brandSlug;
        modelGroupSelect.disabled = true;
        versionSelect.disabled = true;
        renderOptions(modelGroupSelect, [], 'Modeller yÃ¼kleniyor...');
        renderOptions(versionSelect, [], 'Ã–nce model seÃ§in');

        if (!brandSlug) {
          renderOptions(modelGroupSelect, [], 'Ã–nce marka seÃ§in');
          return;
        }

        try {
          const response = await fetch(`/api/models?category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brandSlug)}`);
          if (!response.ok) throw new Error('HTTP ' + response.status);
          const payload = await response.json();
          const models = payload.models || [];

          const modelOptions = models.map((m) => ({ value: m.modelSlug, label: m.model, count: m.count }));
          renderOptions(modelGroupSelect, modelOptions, modelOptions.length ? 'Model seÃ§in' : 'Model bulunamadÄ±');
          modelGroupSelect.disabled = modelOptions.length === 0;

          // Ã–nceki seÃ§imi geri yÃ¼kle
          if (selectedFull && selectedBrand === brandSlug) {
            // Hangi modele ait olduÄŸunu bulmak iÃ§in versiyonlarÄ± sÄ±rayla dene
            for (const m of models) {
              try {
                const vRes = await fetch(`/api/versions?category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brandSlug)}&model=${encodeURIComponent(m.modelSlug)}`);
                const vPayload = await vRes.json();
                const versions = vPayload.versions || [];
                const flat = flattenVersions(versions);
                if (flat.find((f) => f.value === selectedFull)) {
                  modelGroupSelect.value = m.modelSlug;
                  await loadVersions(category, brandSlug, m.modelSlug, selectedFull);
                  return;
                }
              } catch (e) { /* devam */ }
            }
          }
        } catch (error) {
          renderOptions(modelGroupSelect, [], 'Model listesi alÄ±namadÄ±');
          modelGroupSelect.disabled = true;
        }
      }

      function flattenVersions(versions) {
        const flat = [];
        for (const ver of (versions || [])) {
          if ((ver.packages || []).length) {
            for (const pkg of ver.packages) {
              flat.push({ value: pkg.value, label: pkg.value });
            }
          } else {
            flat.push({ value: ver.baseValue, label: ver.baseValue });
          }
        }
        return flat;
      }

      async function loadVersions(category, brandSlug, modelSlug, preselect) {
        versionSelect.disabled = true;
        // Versiyon deÄŸiÅŸtiÄŸinde slug'Ä± sÄ±fÄ±rla
        if (versionSlugInput) versionSlugInput.value = '';
        renderOptions(versionSelect, [], 'Versiyonlar yÃ¼kleniyor...');

        if (!modelSlug || !brandSlug) {
          renderOptions(versionSelect, [], 'Ã–nce model seÃ§in');
          return;
        }

        try {
          const response = await fetch(`/api/versions?category=${encodeURIComponent(category)}&brand=${encodeURIComponent(brandSlug)}&model=${encodeURIComponent(modelSlug)}`);
          if (!response.ok) throw new Error('HTTP ' + response.status);
          const payload = await response.json();
          const versions = payload.versions || [];

          // Her option'a hem gÃ¶rÃ¼nen deÄŸer hem de versionSlug'Ä± ekle
          versionSelect.innerHTML = '';
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = versions.length ? 'Versiyon seÃ§in' : 'Versiyon bulunamadÄ±';
          versionSelect.appendChild(defaultOpt);

          for (const ver of versions) {
            if ((ver.packages || []).length) {
              for (const pkg of ver.packages) {
                const opt = document.createElement('option');
                opt.value = pkg.value;
                opt.dataset.slug = pkg.fullSlug || ver.versionSlug; // Paket varsa fullSlug kullan
                opt.textContent = ver.count ? `${pkg.value} (${ver.count})` : pkg.value;
                versionSelect.appendChild(opt);
              }
            } else {
              const opt = document.createElement('option');
              opt.value = ver.baseValue;
              opt.dataset.slug = ver.versionSlug;
              opt.textContent = ver.count ? `${ver.baseValue} (${ver.count})` : ver.baseValue;
              versionSelect.appendChild(opt);
            }
          }

          versionSelect.disabled = versions.length === 0;

          if (preselect) {
            versionSelect.value = preselect;
            // Preselect'te de slug'Ä± gÃ¼ncelle
            const sel = versionSelect.options[versionSelect.selectedIndex];
            if (sel && versionSlugInput) versionSlugInput.value = sel.dataset.slug || '';
          }
        } catch (error) {
          renderOptions(versionSelect, [], 'Versiyonlar alÄ±namadÄ±');
          versionSelect.disabled = true;
        }
      }

      categorySelect.addEventListener('change', (event) => {
        loadBrands(event.target.value);
      });

      brandSelect.addEventListener('change', (event) => {
        loadModels(categorySelect.value, event.target.value);
      });

      modelGroupSelect.addEventListener('change', (event) => {
        if (modelSlugInput) modelSlugInput.value = event.target.value;
        if (versionSlugInput) versionSlugInput.value = '';
        loadVersions(categorySelect.value, currentBrand, event.target.value, null);
      });

      // Versiyon seÃ§ildiÄŸinde versionSlug hidden field'Ä± gÃ¼ncelle
      versionSelect.addEventListener('change', (event) => {
        const sel = event.target.options[event.target.selectedIndex];
        if (versionSlugInput) versionSlugInput.value = (sel && sel.dataset.slug) || '';
        triggerPrefetch();
      });

      // KM veya YÄ±l deÄŸiÅŸtiÄŸinde de prefetch tetikle
      document.querySelector('input[name="km"]').addEventListener('blur', triggerPrefetch);
      document.querySelector('input[name="yil"]').addEventListener('blur', triggerPrefetch);

      async function triggerPrefetch() {
        const category = categorySelect.value;
        const brand = brandSelect.value;
        const modelSlug = modelGroupSelect.value;
        const versionSlug = versionSlugInput ? versionSlugInput.value : '';
        const yil = document.querySelector('input[name="yil"]').value;
        const km = document.querySelector('input[name="km"]').value;
        const vites = document.querySelector('select[name="vites"]').value;

        if (brand && modelSlug) {
          const params = new URLSearchParams({
            category, brand, modelSlug, versionSlug, yil, km, vites
          });
          // Sessizce Ã§aÄŸÄ±r (hata Ã¶nemli deÄŸil)
          fetch(`/api/prefetch?${params.toString()}`).catch(() => { });
        }
      }

      loadBrands(categorySelect.value || 'otomobil');
    })();
  </script>
</body>

</html>